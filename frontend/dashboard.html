<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - WebGST</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">WebGST</h1>
            <div class="space-x-4">
                <a href="dashboard.html" class="font-bold hover:underline">Dashboard</a>
                <a href="products.html" class="hover:underline">Products</a>
                <a href="customers.html" class="hover:underline">Customers</a>
                <a href="suppliers.html" class="hover:underline">Suppliers</a>
                <a href="purchases.html" class="hover:underline">Purchases</a>
                <a href="invoices.html" class="hover:underline">Invoices</a>
                <a href="reports.html" class="hover:underline">Reports</a>
                <button onclick="logout()" class="bg-red-500 px-4 py-2 rounded hover:bg-red-600">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-8">
        <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-gray-500 text-sm">Total Products</h3>
                <p id="total-products" class="text-3xl font-bold">-</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-gray-500 text-sm">Total Customers</h3>
                <p id="total-customers" class="text-3xl font-bold">-</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-gray-500 text-sm">Total Invoices</h3>
                <p id="total-invoices" class="text-3xl font-bold">-</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-gray-500 text-sm">This Month Sales</h3>
                <p id="month-sales" class="text-3xl font-bold">₹-</p>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h3 class="text-xl font-bold mb-4">Quick Actions</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <a href="invoices.html?action=create" class="bg-blue-600 text-white p-4 rounded text-center hover:bg-blue-700">
                    Create Invoice
                </a>
                <a href="products.html?action=create" class="bg-green-600 text-white p-4 rounded text-center hover:bg-green-700">
                    Add Product
                </a>
                <a href="customers.html?action=create" class="bg-purple-600 text-white p-4 rounded text-center hover:bg-purple-700">
                    Add Customer
                </a>
                <a href="purchases.html?action=create" class="bg-indigo-600 text-white p-4 rounded text-center hover:bg-indigo-700">
                    Record Purchase
                </a>
                <a href="suppliers.html?action=create" class="bg-amber-600 text-white p-4 rounded text-center hover:bg-amber-700">
                    Add Supplier
                </a>
                <a href="reports.html" class="bg-orange-600 text-white p-4 rounded text-center hover:bg-orange-700">
                    View Reports
                </a>
            </div>
        </div>
        
        <!-- Recent Invoices -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-xl font-bold mb-4">Recent Invoices</h3>
            <div id="recent-invoices" class="space-y-2">
                <p class="text-gray-500">Loading...</p>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000/api';
        
        // Check authentication
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'index.html';
        }
        
        const headers = {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };
        
        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }
        
        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load products count
                const productsRes = await fetch(`${API_URL}/products/`, { headers });
                const products = await productsRes.json();
                document.getElementById('total-products').textContent = products.length;
                
                // Load customers count
                const customersRes = await fetch(`${API_URL}/customers/`, { headers });
                const customers = await customersRes.json();
                document.getElementById('total-customers').textContent = customers.length;
                
                // Load invoices
                const invoicesRes = await fetch(`${API_URL}/invoices/?limit=10`, { headers });
                const invoices = await invoicesRes.json();
                document.getElementById('total-invoices').textContent = invoices.length;
                
                // Calculate this month sales
                const today = new Date();
                const thisMonth = invoices.filter(inv => {
                    const invDate = new Date(inv.invoice_date);
                    return invDate.getMonth() === today.getMonth() && 
                           invDate.getFullYear() === today.getFullYear() &&
                           inv.status !== 'CANCELLED';
                });
                const monthSales = thisMonth.reduce((sum, inv) => sum + parseFloat(inv.grand_total), 0);
                document.getElementById('month-sales').textContent = `₹${monthSales.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                
                // Display recent invoices
                const recentDiv = document.getElementById('recent-invoices');
                if (invoices.length === 0) {
                    recentDiv.innerHTML = '<p class="text-gray-500">No invoices yet</p>';
                } else {
                    recentDiv.innerHTML = invoices.slice(0, 5).map(inv => `
                        <div class="flex justify-between items-center p-3 border rounded hover:bg-gray-50">
                            <div>
                                <span class="font-bold">${inv.invoice_number}</span> - 
                                <span>${inv.customer_name}</span>
                            </div>
                            <div>
                                <span class="font-bold text-green-600">₹${parseFloat(inv.grand_total).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                                <span class="text-gray-500 text-sm ml-2">${inv.invoice_date}</span>
                            </div>
                        </div>
                    `).join('');
                }
                
            } catch (err) {
                console.error('Error loading dashboard:', err);
                if (err.message.includes('401')) {
                    logout();
                }
            }
        }
        
        loadDashboard();
    </script>
</body>
</html>
