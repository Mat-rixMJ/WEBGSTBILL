<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Invoices - WebGST</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">WebGST</h1>
            <div class="space-x-4">
                <a href="dashboard.html" class="hover:underline">Dashboard</a>
                <a href="products.html" class="hover:underline">Products</a>
                <a href="customers.html" class="hover:underline">Customers</a>
                <a href="suppliers.html" class="hover:underline">Suppliers</a>
                <a href="purchases.html" class="font-bold hover:underline">Purchases</a>
                <a href="invoices.html" class="hover:underline">Sales</a>
                <a href="reports.html" class="hover:underline">Reports</a>
                <button onclick="logout()" class="bg-red-500 px-4 py-2 rounded hover:bg-red-600">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold">Purchase Invoices (INPUT GST)</h2>
            <button onclick="showAddModal()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                + Create Purchase Invoice
            </button>
        </div>

        <!-- Search and Filter -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <input type="text" id="search" placeholder="Search by supplier, invoice no..." 
                       class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="filter-status" class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Status</option>
                    <option value="Draft">Draft</option>
                    <option value="Finalized">Finalized</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
                <input type="date" id="filter-date" 
                       class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="loadPurchases()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                    Search
                </button>
            </div>
        </div>

        <!-- Purchase Invoices Table -->
        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-100 border-b">
                    <tr>
                        <th class="px-4 py-3 text-left">Supplier Invoice</th>
                        <th class="px-4 py-3 text-left">Supplier</th>
                        <th class="px-4 py-3 text-center">Date</th>
                        <th class="px-4 py-3 text-right">Taxable Value</th>
                        <th class="px-4 py-3 text-right">Input GST</th>
                        <th class="px-4 py-3 text-right">Grand Total</th>
                        <th class="px-4 py-3 text-center">Status</th>
                        <th class="px-4 py-3 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="purchases-table">
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                            Loading purchase invoices...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Create Purchase Invoice Modal -->
    <div id="purchase-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-6xl w-full mx-4 max-h-screen overflow-y-auto">
            <h3 id="modal-title" class="text-2xl font-bold mb-6">Create Purchase Invoice</h3>
            
            <form id="purchase-form" class="space-y-6">
                <!-- Supplier Selection -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            Supplier <span class="text-red-500">*</span>
                        </label>
                        <select id="supplier_id" required onchange="onSupplierChange()"
                                class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Select Supplier --</option>
                        </select>
                        <p id="supplier-details" class="text-xs text-gray-600 mt-1"></p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            Place of Supply <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="place_of_supply" readonly
                               class="w-full px-4 py-2 border rounded bg-gray-100 text-gray-700"
                               placeholder="Auto-filled from supplier">
                    </div>
                </div>

                <!-- Invoice Details -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            Supplier Invoice No <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="supplier_invoice_no" required maxlength="100"
                               class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="e.g., SI/2025/001">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            Supplier Invoice Date <span class="text-red-500">*</span>
                        </label>
                        <input type="date" id="supplier_invoice_date" required
                               class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">
                        Purchase Date (Goods Received) <span class="text-red-500">*</span>
                    </label>
                    <input type="date" id="purchase_date" required
                           class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Items Section -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <label class="block text-sm font-medium">
                            Purchase Items <span class="text-red-500">*</span>
                        </label>
                        <button type="button" onclick="addItem()" class="bg-green-600 text-white px-4 py-1 rounded text-sm hover:bg-green-700">
                            + Add Item
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-2 py-2 text-left text-sm">Item Name</th>
                                    <th class="px-2 py-2 text-left text-sm">HSN Code</th>
                                    <th class="px-2 py-2 text-right text-sm">Quantity</th>
                                    <th class="px-2 py-2 text-right text-sm">Rate (₹)</th>
                                    <th class="px-2 py-2 text-center text-sm">GST %</th>
                                    <th class="px-2 py-2 text-right text-sm">Taxable Value</th>
                                    <th class="px-2 py-2 text-right text-sm">GST Amount</th>
                                    <th class="px-2 py-2 text-right text-sm">Total</th>
                                    <th class="px-2 py-2 text-center text-sm">Action</th>
                                </tr>
                            </thead>
                            <tbody id="items-table">
                                <!-- Items will be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- GST Breakup Preview -->
                <div class="bg-blue-50 border border-blue-200 rounded p-4">
                    <h4 class="font-bold mb-3 text-blue-900">INPUT GST (ITC) Breakup</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <label class="text-gray-600">Taxable Value:</label>
                            <div id="preview-taxable" class="font-bold text-lg">₹0.00</div>
                        </div>
                        <div>
                            <label class="text-gray-600">CGST:</label>
                            <div id="preview-cgst" class="font-bold text-lg">₹0.00</div>
                        </div>
                        <div>
                            <label class="text-gray-600">SGST:</label>
                            <div id="preview-sgst" class="font-bold text-lg">₹0.00</div>
                        </div>
                        <div>
                            <label class="text-gray-600">IGST:</label>
                            <div id="preview-igst" class="font-bold text-lg">₹0.00</div>
                        </div>
                        <div>
                            <label class="text-gray-600">Total GST:</label>
                            <div id="preview-gst" class="font-bold text-lg text-blue-600">₹0.00</div>
                        </div>
                        <div class="md:col-span-3">
                            <label class="text-gray-600">Grand Total:</label>
                            <div id="preview-total" class="font-bold text-xl text-green-600">₹0.00</div>
                        </div>
                    </div>
                    <p class="text-xs text-blue-600 mt-3">
                        <span id="tax-type-info"></span>
                    </p>
                </div>

                <!-- Error Display -->
                <div id="error-message" class="hidden p-4 bg-red-50 border border-red-300 rounded text-red-700 text-sm">
                </div>

                <!-- Form Actions -->
                <div class="flex space-x-4 pt-4">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700 font-medium">
                        Save as Draft
                    </button>
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded hover:bg-gray-400 font-medium">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Align with backend on port 8000 and current host to avoid CORS/redirect issues
        const API_HOST = window.location.hostname || '127.0.0.1';
        const API_BASE = `http://${API_HOST}:8000/api`;
        let suppliers = [];
        let businessState = null;
        let items = [];
        let itemCounter = 0;

        // Check auth on page load
        window.onload = function() {
            if (!localStorage.getItem('token')) {
                window.location.href = 'index.html';
                return;
            }
            loadSuppliers();
            loadPurchases();
            // Set default dates to today
            document.getElementById('supplier_invoice_date').valueAsDate = new Date();
            document.getElementById('purchase_date').valueAsDate = new Date();
        };

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }

        // Load suppliers for dropdown
        async function loadSuppliers() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/suppliers?active_only=true&limit=1000`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    suppliers = await response.json();
                    const select = document.getElementById('supplier_id');
                    suppliers.forEach(s => {
                        const option = document.createElement('option');
                        option.value = s.id;
                        option.textContent = `${s.name} (${s.supplier_type})`;
                        option.dataset.state = s.state;
                        option.dataset.gstin = s.gstin || '';
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading suppliers:', error);
            }
        }

        // Supplier selection changed
        function onSupplierChange() {
            const select = document.getElementById('supplier_id');
            const selected = select.options[select.selectedIndex];
            
            if (selected.value) {
                const state = selected.dataset.state;
                const gstin = selected.dataset.gstin;
                document.getElementById('place_of_supply').value = state;
                document.getElementById('supplier-details').textContent = 
                    gstin ? `GSTIN: ${gstin} | State: ${state}` : `State: ${state} (Unregistered)`;
            } else {
                document.getElementById('place_of_supply').value = '';
                document.getElementById('supplier-details').textContent = '';
            }
            updatePreview();
        }

        // Show add modal
        function showAddModal() {
            document.getElementById('modal-title').textContent = 'Create Purchase Invoice';
            document.getElementById('purchase-form').reset();
            document.getElementById('error-message').classList.add('hidden');
            items = [];
            itemCounter = 0;
            document.getElementById('items-table').innerHTML = '';
            document.getElementById('supplier_invoice_date').valueAsDate = new Date();
            document.getElementById('purchase_date').valueAsDate = new Date();
            addItem(); // Add first empty item
            updatePreview();
            document.getElementById('purchase-modal').classList.remove('hidden');
        }

        // Close modal
        function closeModal() {
            document.getElementById('purchase-modal').classList.add('hidden');
        }

        // Add item row
        function addItem() {
            itemCounter++;
            const row = document.createElement('tr');
            row.id = `item-${itemCounter}`;
            row.className = 'border-b';
            row.innerHTML = `
                <td class="px-2 py-2">
                    <input type="text" data-field="item_name" required minlength="1" maxlength="255"
                           class="w-full px-2 py-1 border rounded text-sm"
                           placeholder="Item name" onchange="updateItemCalc(${itemCounter})">
                </td>
                <td class="px-2 py-2">
                    <input type="text" data-field="hsn_code" required pattern="[0-9]{4,8}"
                           class="w-full px-2 py-1 border rounded text-sm"
                           placeholder="HSN" maxlength="8" onchange="updateItemCalc(${itemCounter})">
                </td>
                <td class="px-2 py-2">
                    <input type="number" data-field="quantity" required step="0.01" min="0.01"
                           class="w-full px-2 py-1 border rounded text-sm text-right"
                           placeholder="0" onchange="updateItemCalc(${itemCounter})">
                </td>
                <td class="px-2 py-2">
                    <input type="number" data-field="rate" required step="0.01" min="0"
                           class="w-full px-2 py-1 border rounded text-sm text-right"
                           placeholder="0.00" onchange="updateItemCalc(${itemCounter})">
                </td>
                <td class="px-2 py-2">
                    <select data-field="gst_rate" required onchange="updateItemCalc(${itemCounter})"
                            class="w-full px-2 py-1 border rounded text-sm">
                        <option value="">--</option>
                        <option value="0">0%</option>
                        <option value="5">5%</option>
                        <option value="12">12%</option>
                        <option value="18">18%</option>
                        <option value="28">28%</option>
                    </select>
                </td>
                <td class="px-2 py-2 text-right text-sm" data-display="taxable">₹0.00</td>
                <td class="px-2 py-2 text-right text-sm" data-display="gst">₹0.00</td>
                <td class="px-2 py-2 text-right text-sm font-bold" data-display="total">₹0.00</td>
                <td class="px-2 py-2 text-center">
                    <button type="button" onclick="removeItem(${itemCounter})" 
                            class="text-red-600 hover:text-red-800 text-xs">✕</button>
                </td>
            `;
            document.getElementById('items-table').appendChild(row);
        }

        // Remove item row
        function removeItem(id) {
            const row = document.getElementById(`item-${id}`);
            if (row) {
                row.remove();
                updatePreview();
            }
        }

        // Update item calculations
        function updateItemCalc(id) {
            const row = document.getElementById(`item-${id}`);
            if (!row) return;

            const qty = parseFloat(row.querySelector('[data-field="quantity"]').value) || 0;
            const rate = parseFloat(row.querySelector('[data-field="rate"]').value) || 0;
            const gstRate = parseInt(row.querySelector('[data-field="gst_rate"]').value) || 0;

            const taxableValue = qty * rate;
            const gstAmount = (taxableValue * gstRate) / 100;
            const total = taxableValue + gstAmount;

            row.querySelector('[data-display="taxable"]').textContent = `₹${taxableValue.toFixed(2)}`;
            row.querySelector('[data-display="gst"]').textContent = `₹${gstAmount.toFixed(2)}`;
            row.querySelector('[data-display="total"]').textContent = `₹${total.toFixed(2)}`;

            updatePreview();
        }

        // Update preview totals
        function updatePreview() {
            const rows = document.querySelectorAll('#items-table tr');
            let totalTaxable = 0;
            let totalGST = 0;
            let cgst = 0;
            let sgst = 0;
            let igst = 0;

            // Get supplier state
            const supplierSelect = document.getElementById('supplier_id');
            const supplierOption = supplierSelect.options[supplierSelect.selectedIndex];
            const supplierState = supplierOption ? supplierOption.dataset.state : null;

            // Assume business is in Karnataka (29) - should be dynamic from business profile
            const businessState = "Karnataka";
            const isSameState = supplierState === businessState;

            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('[data-field="quantity"]')?.value) || 0;
                const rate = parseFloat(row.querySelector('[data-field="rate"]')?.value) || 0;
                const gstRate = parseInt(row.querySelector('[data-field="gst_rate"]')?.value) || 0;

                const taxable = qty * rate;
                const gst = (taxable * gstRate) / 100;

                totalTaxable += taxable;
                totalGST += gst;

                if (isSameState) {
                    cgst += gst / 2;
                    sgst += gst / 2;
                } else {
                    igst += gst;
                }
            });

            const grandTotal = totalTaxable + totalGST;

            document.getElementById('preview-taxable').textContent = `₹${totalTaxable.toFixed(2)}`;
            document.getElementById('preview-cgst').textContent = `₹${cgst.toFixed(2)}`;
            document.getElementById('preview-sgst').textContent = `₹${sgst.toFixed(2)}`;
            document.getElementById('preview-igst').textContent = `₹${igst.toFixed(2)}`;
            document.getElementById('preview-gst').textContent = `₹${totalGST.toFixed(2)}`;
            document.getElementById('preview-total').textContent = `₹${grandTotal.toFixed(2)}`;

            if (supplierState) {
                document.getElementById('tax-type-info').textContent = isSameState
                    ? `ℹ️ Same state transaction (${supplierState}) → Input CGST + Input SGST`
                    : `ℹ️ Inter-state transaction (Supplier: ${supplierState}) → Input IGST`;
            } else {
                document.getElementById('tax-type-info').textContent = '';
            }
        }

        // Handle form submission
        document.getElementById('purchase-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Collect items
            const itemRows = document.querySelectorAll('#items-table tr');
            const items = [];
            
            itemRows.forEach(row => {
                const item_name = row.querySelector('[data-field="item_name"]').value.trim();
                const hsn_code = row.querySelector('[data-field="hsn_code"]').value.trim();
                const quantity = parseFloat(row.querySelector('[data-field="quantity"]').value);
                const rate = parseFloat(row.querySelector('[data-field="rate"]').value);
                const gst_rate = parseInt(row.querySelector('[data-field="gst_rate"]').value);

                if (item_name && hsn_code && quantity > 0 && gst_rate !== null) {
                    items.push({
                        item_name,
                        hsn_code,
                        quantity,
                        rate: Math.round(rate * 100), // Convert to paise
                        gst_rate
                    });
                }
            });

            if (items.length === 0) {
                showError('At least one item is required');
                return;
            }

            const purchaseData = {
                supplier_id: parseInt(document.getElementById('supplier_id').value),
                supplier_invoice_no: document.getElementById('supplier_invoice_no').value.trim(),
                supplier_invoice_date: document.getElementById('supplier_invoice_date').value + 'T00:00:00',
                purchase_date: document.getElementById('purchase_date').value + 'T00:00:00',
                items
            };

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/purchases`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(purchaseData)
                });

                if (response.ok) {
                    closeModal();
                    loadPurchases();
                } else {
                    const error = await response.json();
                    showError(error.detail || 'Failed to create purchase invoice');
                }
            } catch (error) {
                console.error('Error creating purchase:', error);
                showError('Failed to create purchase invoice');
            }
        });

        // Load purchases
        async function loadPurchases() {
            try {
                const token = localStorage.getItem('token');
                const status = document.getElementById('filter-status').value;
                let url = `${API_BASE}/purchases?limit=1000`;
                if (status) url += `&status=${status}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                const data = await response.json();
                displayPurchases(data.value || []);
            } catch (error) {
                console.error('Error loading purchases:', error);
                showError('Failed to load purchase invoices');
            }
        }

        // Display purchases in table
        function displayPurchases(purchases) {
            const tbody = document.getElementById('purchases-table');

            if (purchases.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                            No purchase invoices found. Click "+ Create Purchase Invoice" to add one.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = purchases.map(p => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3">
                        <div class="font-medium">${escapeHtml(p.supplier_invoice_no)}</div>
                        <div class="text-xs text-gray-500">${formatDate(p.supplier_invoice_date)}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm">${escapeHtml(p.place_of_supply)}</div>
                    </td>
                    <td class="px-4 py-3 text-center text-sm">${formatDate(p.purchase_date)}</td>
                    <td class="px-4 py-3 text-right font-mono">₹${(p.total_taxable_value / 100).toFixed(2)}</td>
                    <td class="px-4 py-3 text-right font-mono text-blue-600">₹${(p.total_gst / 100).toFixed(2)}</td>
                    <td class="px-4 py-3 text-right font-mono font-bold">₹${(p.grand_total / 100).toFixed(2)}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 text-xs rounded ${getStatusClass(p.status)}">
                            ${p.status}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center text-sm">
                        <button onclick="viewPurchase(${p.id})" class="text-blue-600 hover:text-blue-800 mr-2">View</button>
                        ${p.status === 'Draft' ? `
                            <button onclick="finalizePurchase(${p.id})" class="text-green-600 hover:text-green-800 mr-2">Finalize</button>
                        ` : ''}
                        ${p.status !== 'Cancelled' ? `
                            <button onclick="cancelPurchase(${p.id})" class="text-red-600 hover:text-red-800">Cancel</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function getStatusClass(status) {
            const classes = {
                'Draft': 'bg-yellow-100 text-yellow-800',
                'Finalized': 'bg-green-100 text-green-800',
                'Cancelled': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-IN');
        }

        function viewPurchase(id) {
            window.location.href = `purchase-view.html?id=${id}`;
        }

        async function finalizePurchase(id) {
            if (!confirm('Finalize this purchase invoice?\n\n• Invoice will be locked from editing\n• Stock will be updated')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/purchases/${id}/finalize`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    loadPurchases();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to finalize purchase'));
                }
            } catch (error) {
                console.error('Error finalizing purchase:', error);
                alert('Failed to finalize purchase');
            }
        }

        async function cancelPurchase(id) {
            const reason = prompt('Enter cancellation reason:');
            if (!reason || reason.trim() === '') return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/purchases/${id}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ cancel_reason: reason.trim() })
                });

                if (response.ok) {
                    loadPurchases();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to cancel purchase'));
                }
            } catch (error) {
                console.error('Error cancelling purchase:', error);
                alert('Failed to cancel purchase');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
