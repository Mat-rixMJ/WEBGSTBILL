<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suppliers - WebGST</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">WebGST</h1>
            <div class="space-x-4">
                <a href="dashboard.html" class="hover:underline">Dashboard</a>
                <a href="products.html" class="hover:underline">Products</a>
                <a href="customers.html" class="hover:underline">Customers</a>
                <a href="suppliers.html" class="font-bold hover:underline">Suppliers</a>
                <a href="invoices.html" class="hover:underline">Invoices</a>
                <a href="reports.html" class="hover:underline">Reports</a>
                <button onclick="logout()" class="bg-red-500 px-4 py-2 rounded hover:bg-red-600">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold">Suppliers / Vendors</h2>
            <button onclick="showAddModal()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                + Add Supplier
            </button>
        </div>

        <!-- Search and Filter -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <input type="text" id="search" placeholder="Search by name, GSTIN..." 
                       class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="filter-type" class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Types</option>
                    <option value="REGISTERED">Registered Only</option>
                    <option value="UNREGISTERED">Unregistered Only</option>
                </select>
                <select id="filter-active" class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="true">Active Only</option>
                    <option value="false">Inactive Only</option>
                    <option value="">All Suppliers</option>
                </select>
                <button onclick="loadSuppliers()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                    Search
                </button>
            </div>
        </div>

        <!-- Suppliers Table -->
        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-100 border-b">
                    <tr>
                        <th class="px-4 py-3 text-left">Name</th>
                        <th class="px-4 py-3 text-center">Type</th>
                        <th class="px-4 py-3 text-left">GSTIN</th>
                        <th class="px-4 py-3 text-left">State</th>
                        <th class="px-4 py-3 text-left">Contact</th>
                        <th class="px-4 py-3 text-center">Status</th>
                        <th class="px-4 py-3 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="suppliers-table">
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            Loading suppliers...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit Supplier Modal -->
    <div id="supplier-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <h3 id="modal-title" class="text-2xl font-bold mb-6">Add Supplier</h3>
            
            <form id="supplier-form" class="space-y-4">
                <!-- Supplier Name -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        Supplier Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="name" required minlength="2" maxlength="255"
                           class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="e.g., XYZ Chemicals Pvt Ltd, Supplier Name">
                </div>

                <!-- Supplier Type -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        Supplier Type <span class="text-red-500">*</span>
                    </label>
                    <div class="flex space-x-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="supplier_type" value="REGISTERED" required 
                                   class="mr-2" onchange="toggleGSTIN()">
                            <span class="font-medium">REGISTERED</span>
                            <span class="ml-2 text-xs text-gray-500">- GSTIN required</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="supplier_type" value="UNREGISTERED" required 
                                   class="mr-2" onchange="toggleGSTIN()" checked>
                            <span class="font-medium">UNREGISTERED</span>
                            <span class="ml-2 text-xs text-gray-500">- No GSTIN</span>
                        </label>
                    </div>
                    <p class="text-xs text-blue-600 mt-2 p-2 bg-blue-50 rounded">
                        ℹ️ REGISTERED suppliers must have valid GSTIN. UNREGISTERED suppliers cannot have GSTIN.
                    </p>
                </div>

                <!-- GSTIN Field -->
                <div id="gstin-field">
                    <label class="block text-sm font-medium mb-2">
                        GSTIN <span id="gstin-required" class="text-red-500 hidden">*</span>
                        <span class="text-xs text-gray-500">(15 characters)</span>
                    </label>
                    <input type="text" id="gstin" maxlength="15" pattern="[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}"
                           class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase"
                           placeholder="e.g., 27ABCDE1234F1Z5"
                           oninput="handleGSTINInput(this)"
                           onchange="deriveStateFromGSTIN()"
                           disabled>
                    <p class="text-xs text-gray-600 mt-1">
                        Format: 2-digit state code + 10-char PAN + entity + Z + checksum
                    </p>
                    <p id="gstin-validation-msg" class="text-xs mt-1 hidden"></p>
                </div>

                <!-- State Selection -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        State <span class="text-red-500">*</span>
                    </label>
                    <select id="state" required onchange="updateStateCode()"
                            class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Select State --</option>
                        <option value="Andhra Pradesh" data-code="37">Andhra Pradesh</option>
                        <option value="Arunachal Pradesh" data-code="12">Arunachal Pradesh</option>
                        <option value="Assam" data-code="18">Assam</option>
                        <option value="Bihar" data-code="10">Bihar</option>
                        <option value="Chhattisgarh" data-code="22">Chhattisgarh</option>
                        <option value="Goa" data-code="30">Goa</option>
                        <option value="Gujarat" data-code="24">Gujarat</option>
                        <option value="Haryana" data-code="06">Haryana</option>
                        <option value="Himachal Pradesh" data-code="02">Himachal Pradesh</option>
                        <option value="Jharkhand" data-code="20">Jharkhand</option>
                        <option value="Karnataka" data-code="29">Karnataka</option>
                        <option value="Kerala" data-code="32">Kerala</option>
                        <option value="Madhya Pradesh" data-code="23">Madhya Pradesh</option>
                        <option value="Maharashtra" data-code="27">Maharashtra</option>
                        <option value="Manipur" data-code="14">Manipur</option>
                        <option value="Meghalaya" data-code="17">Meghalaya</option>
                        <option value="Mizoram" data-code="15">Mizoram</option>
                        <option value="Nagaland" data-code="13">Nagaland</option>
                        <option value="Odisha" data-code="21">Odisha</option>
                        <option value="Punjab" data-code="03">Punjab</option>
                        <option value="Rajasthan" data-code="08">Rajasthan</option>
                        <option value="Sikkim" data-code="11">Sikkim</option>
                        <option value="Tamil Nadu" data-code="33">Tamil Nadu</option>
                        <option value="Telangana" data-code="36">Telangana</option>
                        <option value="Tripura" data-code="16">Tripura</option>
                        <option value="Uttar Pradesh" data-code="09">Uttar Pradesh</option>
                        <option value="Uttarakhand" data-code="05">Uttarakhand</option>
                        <option value="West Bengal" data-code="19">West Bengal</option>
                        <option value="Andaman and Nicobar Islands" data-code="35">Andaman and Nicobar Islands</option>
                        <option value="Chandigarh" data-code="04">Chandigarh</option>
                        <option value="Dadra and Nagar Haveli and Daman and Diu" data-code="26">Dadra and Nagar Haveli and Daman and Diu</option>
                        <option value="Delhi" data-code="07">Delhi</option>
                        <option value="Jammu and Kashmir" data-code="01">Jammu and Kashmir</option>
                        <option value="Ladakh" data-code="38">Ladakh</option>
                        <option value="Lakshadweep" data-code="31">Lakshadweep</option>
                        <option value="Puducherry" data-code="34">Puducherry</option>
                    </select>
                </div>

                <!-- State Code (Auto-derived, Read-only) -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        State Code (Auto-filled) <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="state_code" required pattern="[0-9]{2}" maxlength="2"
                           class="w-full px-4 py-2 border rounded bg-gray-100 text-gray-700"
                           placeholder="Auto-filled from state selection"
                           readonly>
                    <p class="text-xs text-gray-600 mt-1">
                        2-digit state code (automatically derived from state)
                    </p>
                </div>

                <!-- Address -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        Address <span class="text-red-500">*</span>
                    </label>
                    <textarea id="address" required minlength="5" maxlength="500" rows="2"
                              class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Complete address with building, street, area, city, pincode"></textarea>
                </div>

                <!-- Phone -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        Phone <span class="text-gray-500">(Optional)</span>
                    </label>
                    <input type="tel" id="phone" maxlength="15"
                           class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="e.g., +919876543210">
                </div>

                <!-- Email -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        Email <span class="text-gray-500">(Optional)</span>
                    </label>
                    <input type="email" id="email" maxlength="255"
                           class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="e.g., contact@supplier.com">
                </div>

                <!-- Error Display -->
                <div id="error-message" class="hidden p-4 bg-red-50 border border-red-300 rounded text-red-700 text-sm">
                </div>

                <!-- Form Actions -->
                <div class="flex space-x-4 pt-4">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700 font-medium">
                        Save Supplier
                    </button>
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded hover:bg-gray-400 font-medium">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let editingId = null;

        // Check auth on page load
        window.onload = function() {
            if (!localStorage.getItem('token')) {
                window.location.href = 'index.html';
                return;
            }
            loadSuppliers();
        };

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }

        // Toggle GSTIN field based on supplier type
        function toggleGSTIN() {
            const supplierType = document.querySelector('input[name="supplier_type"]:checked').value;
            const gstinField = document.getElementById('gstin');
            const gstinRequired = document.getElementById('gstin-required');
            
            if (supplierType === 'REGISTERED') {
                gstinField.disabled = false;
                gstinField.required = true;
                gstinRequired.classList.remove('hidden');
            } else {
                gstinField.disabled = true;
                gstinField.required = false;
                gstinField.value = '';
                gstinRequired.classList.add('hidden');
                clearGSTINValidation();
            }
        }

        // Handle GSTIN input validation
        function handleGSTINInput(input) {
            input.value = input.value.toUpperCase();
            
            if (input.value.length === 15) {
                validateGSTINFormat(input.value);
            } else {
                clearGSTINValidation();
            }
        }

        // Validate GSTIN format (client-side basic check)
        function validateGSTINFormat(gstin) {
            const pattern = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;
            const msgEl = document.getElementById('gstin-validation-msg');
            
            if (pattern.test(gstin)) {
                msgEl.textContent = '✓ GSTIN format is valid';
                msgEl.className = 'text-xs mt-1 text-green-600';
                msgEl.classList.remove('hidden');
                
                // Derive state from GSTIN
                deriveStateFromGSTIN();
            } else {
                msgEl.textContent = '✗ Invalid GSTIN format';
                msgEl.className = 'text-xs mt-1 text-red-600';
                msgEl.classList.remove('hidden');
            }
        }

        function clearGSTINValidation() {
            const msgEl = document.getElementById('gstin-validation-msg');
            msgEl.classList.add('hidden');
        }

        // Derive state from GSTIN state code
        function deriveStateFromGSTIN() {
            const gstin = document.getElementById('gstin').value;
            if (gstin.length >= 2) {
                const stateCode = gstin.substring(0, 2);
                const stateSelect = document.getElementById('state');
                
                // Find option with matching state code
                for (let option of stateSelect.options) {
                    if (option.dataset.code === stateCode) {
                        stateSelect.value = option.value;
                        updateStateCode();
                        break;
                    }
                }
            }
        }

        // Update state code when state is selected
        function updateStateCode() {
            const stateSelect = document.getElementById('state');
            const stateCodeInput = document.getElementById('state_code');
            const selectedOption = stateSelect.options[stateSelect.selectedIndex];
            
            if (selectedOption.dataset.code) {
                stateCodeInput.value = selectedOption.dataset.code;
            } else {
                stateCodeInput.value = '';
            }
        }

        // Show add modal
        function showAddModal() {
            editingId = null;
            document.getElementById('modal-title').textContent = 'Add Supplier';
            document.getElementById('supplier-form').reset();
            document.getElementById('error-message').classList.add('hidden');
            
            // Set default to UNREGISTERED
            document.querySelector('input[name="supplier_type"][value="UNREGISTERED"]').checked = true;
            toggleGSTIN();
            
            document.getElementById('supplier-modal').classList.remove('hidden');
        }

        // Show edit modal
        function showEditModal(supplier) {
            editingId = supplier.id;
            document.getElementById('modal-title').textContent = 'Edit Supplier';
            document.getElementById('error-message').classList.add('hidden');
            
            // Fill form
            document.getElementById('name').value = supplier.name;
            document.querySelector(`input[name="supplier_type"][value="${supplier.supplier_type}"]`).checked = true;
            document.getElementById('gstin').value = supplier.gstin || '';
            document.getElementById('address').value = supplier.address;
            document.getElementById('state').value = supplier.state;
            document.getElementById('state_code').value = supplier.state_code;
            document.getElementById('phone').value = supplier.phone || '';
            document.getElementById('email').value = supplier.email || '';
            
            toggleGSTIN();
            document.getElementById('supplier-modal').classList.remove('hidden');
        }

        // Close modal
        function closeModal() {
            document.getElementById('supplier-modal').classList.add('hidden');
            editingId = null;
        }

        // Load suppliers
        async function loadSuppliers() {
            try {
                const token = localStorage.getItem('token');
                const activeFilter = document.getElementById('filter-active').value;
                const typeFilter = document.getElementById('filter-type').value;
                const searchTerm = document.getElementById('search').value.toLowerCase();
                
                let url = `${API_BASE}/suppliers?limit=1000`;
                if (activeFilter !== '') {
                    url += `&active_only=${activeFilter}`;
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const suppliers = await response.json();
                
                // Apply filters
                let filtered = suppliers;
                if (typeFilter) {
                    filtered = filtered.filter(s => s.supplier_type === typeFilter);
                }
                if (searchTerm) {
                    filtered = filtered.filter(s => 
                        s.name.toLowerCase().includes(searchTerm) ||
                        (s.gstin && s.gstin.toLowerCase().includes(searchTerm))
                    );
                }
                
                displaySuppliers(filtered);
            } catch (error) {
                console.error('Error loading suppliers:', error);
                showError('Failed to load suppliers');
            }
        }

        // Display suppliers in table
        function displaySuppliers(suppliers) {
            const tbody = document.getElementById('suppliers-table');
            
            if (suppliers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            No suppliers found. Click "+ Add Supplier" to create one.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = suppliers.map(supplier => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3">
                        <div class="font-medium">${escapeHtml(supplier.name)}</div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 text-xs rounded ${
                            supplier.supplier_type === 'REGISTERED' 
                                ? 'bg-blue-100 text-blue-800' 
                                : 'bg-gray-100 text-gray-800'
                        }">
                            ${supplier.supplier_type}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="font-mono text-sm">${supplier.gstin || '-'}</span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm">${escapeHtml(supplier.state)}</div>
                        <div class="text-xs text-gray-500">Code: ${supplier.state_code}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm">${supplier.phone || '-'}</div>
                        <div class="text-xs text-gray-500">${supplier.email || '-'}</div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 text-xs rounded ${
                            supplier.is_active 
                                ? 'bg-green-100 text-green-800' 
                                : 'bg-red-100 text-red-800'
                        }">
                            ${supplier.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button onclick='editSupplier(${JSON.stringify(supplier)})' 
                                class="text-blue-600 hover:text-blue-800 mr-3">
                            Edit
                        </button>
                        ${supplier.is_active ? `
                            <button onclick="deactivateSupplier(${supplier.id}, '${escapeHtml(supplier.name)}')" 
                                    class="text-red-600 hover:text-red-800">
                                Deactivate
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // Edit supplier
        function editSupplier(supplier) {
            showEditModal(supplier);
        }

        // Deactivate supplier
        async function deactivateSupplier(id, name) {
            if (!confirm(`Are you sure you want to deactivate supplier "${name}"?\n\nThis will hide the supplier from listings but preserve all historical purchase records.`)) {
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/suppliers/${id}/deactivate`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    loadSuppliers();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to deactivate supplier'));
                }
            } catch (error) {
                console.error('Error deactivating supplier:', error);
                alert('Failed to deactivate supplier');
            }
        }

        // Handle form submission
        document.getElementById('supplier-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const supplierType = document.querySelector('input[name="supplier_type"]:checked').value;
            const gstin = document.getElementById('gstin').value.trim() || null;
            
            // Client-side validation
            if (supplierType === 'REGISTERED' && !gstin) {
                showError('GSTIN is required for REGISTERED suppliers');
                return;
            }
            
            if (supplierType === 'UNREGISTERED' && gstin) {
                showError('GSTIN must not be provided for UNREGISTERED suppliers');
                return;
            }
            
            // Match GSTIN state code with selected state code
            if (gstin) {
                const gstinStateCode = gstin.substring(0, 2);
                const selectedStateCode = document.getElementById('state_code').value;
                
                if (gstinStateCode !== selectedStateCode) {
                    showError(`GSTIN state code (${gstinStateCode}) must match selected state code (${selectedStateCode})`);
                    return;
                }
            }
            
            const supplierData = {
                name: document.getElementById('name').value.trim(),
                supplier_type: supplierType,
                gstin: gstin,
                address: document.getElementById('address').value.trim(),
                state: document.getElementById('state').value,
                state_code: document.getElementById('state_code').value,
                phone: document.getElementById('phone').value.trim() || null,
                email: document.getElementById('email').value.trim() || null
            };
            
            try {
                const token = localStorage.getItem('token');
                const url = editingId 
                    ? `${API_BASE}/suppliers/${editingId}` 
                    : `${API_BASE}/suppliers`;
                
                const response = await fetch(url, {
                    method: editingId ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(supplierData)
                });
                
                if (response.ok) {
                    closeModal();
                    loadSuppliers();
                } else {
                    const error = await response.json();
                    showError(error.detail || 'Failed to save supplier');
                }
            } catch (error) {
                console.error('Error saving supplier:', error);
                showError('Failed to save supplier');
            }
        });

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            // Scroll to error
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
