<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - WebGST</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">WebGST</h1>
            <div class="space-x-4">
                <a href="dashboard.html" class="hover:underline">Dashboard</a>
                <a href="products.html" class="font-bold hover:underline">Products</a>
                <a href="customers.html" class="hover:underline">Customers</a>
                <a href="invoices.html" class="hover:underline">Invoices</a>
                <a href="reports.html" class="hover:underline">Reports</a>
                <button onclick="logout()" class="bg-red-500 px-4 py-2 rounded hover:bg-red-600">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold">Products & Services</h2>
            <button onclick="showAddModal()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                + Add Product
            </button>
        </div>

        <!-- Search and Filter -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="search" placeholder="Search by name or HSN..." 
                       class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="filter-active" class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="true">Active Only</option>
                    <option value="false">Inactive Only</option>
                    <option value="">All Products</option>
                </select>
                <button onclick="loadProducts()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                    Search
                </button>
            </div>
        </div>

        <!-- Products Table -->
        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-100 border-b">
                    <tr>
                        <th class="px-4 py-3 text-left">Name</th>
                        <th class="px-4 py-3 text-left">HSN Code</th>
                        <th class="px-4 py-3 text-right">GST Rate</th>
                        <th class="px-4 py-3 text-right">Price (₹)</th>
                        <th class="px-4 py-3 text-right">Stock</th>
                        <th class="px-4 py-3 text-center">Status</th>
                        <th class="px-4 py-3 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="products-table">
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            Loading products...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <h3 id="modal-title" class="text-2xl font-bold mb-6">Add Product</h3>
            
            <form id="product-form" class="space-y-4">
                <!-- Product Name -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        Product/Service Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="name" required minlength="2" maxlength="255"
                           class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="e.g., Laptop Computer, Consulting Services">
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium mb-2">Description</label>
                    <textarea id="description" maxlength="500" rows="2"
                              class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Optional product description"></textarea>
                </div>

                <!-- HSN/SAC Code -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        HSN/SAC Code <span class="text-red-500">*</span>
                        <span class="text-xs text-gray-500">(4, 6, or 8 digits)</span>
                    </label>
                    <input type="text" id="hsn_code" required pattern="[0-9]{4,8}" 
                           class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="e.g., 8471 or 998314"
                           oninput="validateHSN(this)">
                    <p class="text-xs text-gray-600 mt-1">
                        4 digits: For turnover &lt; 5 cr | 6 digits: For turnover &gt; 5 cr | 8 digits: For detailed classification
                    </p>
                </div>

                <!-- GST Rate -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        GST Rate (%) <span class="text-red-500">*</span>
                    </label>
                    <select id="gst_rate" required
                            class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select GST Rate</option>
                        <option value="0">0% (Exempt/Zero-rated)</option>
                        <option value="5">5% (Essential goods)</option>
                        <option value="12">12% (Standard goods)</option>
                        <option value="18">18% (Standard goods & services)</option>
                        <option value="28">28% (Luxury items)</option>
                    </select>
                    <p class="text-xs text-gray-600 mt-1">
                        Standard GST rates as per Indian GST law
                    </p>
                </div>

                <!-- Price -->
                <div>
                    <label class="block text-sm font-medium mb-2">
                        Price per Unit (₹) <span class="text-red-500">*</span>
                    </label>
                    <input type="number" id="price" required min="0" step="0.01"
                           class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="0.00"
                           oninput="calculateTaxBreakup()">
                    <div id="tax-breakup" class="text-xs text-gray-600 mt-1 hidden">
                        Base Price: ₹<span id="base-price">0.00</span> | 
                        Tax: ₹<span id="tax-amount">0.00</span> | 
                        Total: ₹<span id="total-price">0.00</span>
                    </div>
                </div>

                <!-- Stock and Unit -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            Stock Quantity <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="stock_quantity" required min="0" value="0"
                               class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            Unit <span class="text-red-500">*</span>
                        </label>
                        <select id="unit" required
                                class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="PCS">PCS (Pieces)</option>
                            <option value="KG">KG (Kilograms)</option>
                            <option value="LTR">LTR (Liters)</option>
                            <option value="MTR">MTR (Meters)</option>
                            <option value="BOX">BOX</option>
                            <option value="PKT">PKT (Packet)</option>
                            <option value="SET">SET</option>
                            <option value="SVC">SVC (Service)</option>
                        </select>
                    </div>
                </div>

                <!-- Status (for edit mode) -->
                <div id="status-field" class="hidden">
                    <label class="flex items-center">
                        <input type="checkbox" id="is_active" checked class="mr-2">
                        <span class="text-sm font-medium">Product is Active</span>
                    </label>
                </div>

                <!-- Error/Success Messages -->
                <div id="modal-error" class="hidden p-3 bg-red-100 text-red-700 rounded"></div>
                <div id="modal-success" class="hidden p-3 bg-green-100 text-green-700 rounded"></div>

                <!-- Buttons -->
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" onclick="closeModal()" 
                            class="px-6 py-2 border rounded hover:bg-gray-100">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Save Product
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000/api';
        let currentProductId = null;

        // Check authentication
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'index.html';
        }

        const headers = {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };

        // Load products on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
        });

        async function loadProducts() {
            try {
                const search = document.getElementById('search').value;
                const activeFilter = document.getElementById('filter-active').value;
                
                let url = `${API_URL}/products/?limit=1000`;
                if (activeFilter !== '') {
                    url += `&active_only=${activeFilter}`;
                }

                const response = await fetch(url, { headers });
                
                if (response.ok) {
                    let products = await response.json();
                    
                    // Client-side search filter
                    if (search) {
                        const searchLower = search.toLowerCase();
                        products = products.filter(p => 
                            p.name.toLowerCase().includes(searchLower) ||
                            p.hsn_code.includes(search)
                        );
                    }
                    
                    displayProducts(products);
                } else if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = 'index.html';
                } else {
                    showError('Failed to load products');
                }
            } catch (err) {
                showError('Network error. Please check if backend is running.');
            }
        }

        function displayProducts(products) {
            const tbody = document.getElementById('products-table');
            
            if (products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            No products found. Click "Add Product" to create one.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = products.map(product => `
                <tr class="border-b hover:bg-gray-50 ${!product.is_active ? 'bg-gray-100' : ''}">
                    <td class="px-4 py-3">
                        <div class="font-medium">${escapeHtml(product.name)}</div>
                        ${product.description ? `<div class="text-xs text-gray-500">${escapeHtml(product.description)}</div>` : ''}
                    </td>
                    <td class="px-4 py-3 font-mono">${product.hsn_code}</td>
                    <td class="px-4 py-3 text-right">${product.gst_rate}%</td>
                    <td class="px-4 py-3 text-right font-medium">₹${product.price_rupees}</td>
                    <td class="px-4 py-3 text-right">
                        <span class="${product.stock_quantity <= 0 ? 'text-red-600 font-bold' : ''}">
                            ${product.stock_quantity} ${product.unit}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 text-xs rounded ${product.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-200 text-gray-600'}">
                            ${product.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center space-x-2">
                        <button onclick="editProduct(${product.id})" 
                                class="text-blue-600 hover:text-blue-800 text-sm">
                            Edit
                        </button>
                        ${product.is_active ? `
                            <button onclick="deactivateProduct(${product.id})" 
                                    class="text-red-600 hover:text-red-800 text-sm">
                                Deactivate
                            </button>
                        ` : `
                            <button onclick="activateProduct(${product.id})" 
                                    class="text-green-600 hover:text-green-800 text-sm">
                                Activate
                            </button>
                        `}
                    </td>
                </tr>
            `).join('');
        }

        function showAddModal() {
            currentProductId = null;
            document.getElementById('modal-title').textContent = 'Add Product';
            document.getElementById('product-form').reset();
            document.getElementById('status-field').classList.add('hidden');
            document.getElementById('tax-breakup').classList.add('hidden');
            document.getElementById('product-modal').classList.remove('hidden');
        }

        async function editProduct(id) {
            currentProductId = id;
            
            try {
                const response = await fetch(`${API_URL}/products/${id}`, { headers });
                
                if (response.ok) {
                    const product = await response.json();
                    
                    document.getElementById('modal-title').textContent = 'Edit Product';
                    document.getElementById('name').value = product.name;
                    document.getElementById('description').value = product.description || '';
                    document.getElementById('hsn_code').value = product.hsn_code;
                    document.getElementById('gst_rate').value = product.gst_rate;
                    document.getElementById('price').value = product.price_rupees;
                    document.getElementById('stock_quantity').value = product.stock_quantity;
                    document.getElementById('unit').value = product.unit;
                    document.getElementById('is_active').checked = product.is_active;
                    document.getElementById('status-field').classList.remove('hidden');
                    
                    calculateTaxBreakup();
                    document.getElementById('product-modal').classList.remove('hidden');
                } else {
                    showError('Failed to load product details');
                }
            } catch (err) {
                showError('Network error');
            }
        }

        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const priceRupees = parseFloat(document.getElementById('price').value);
            const pricePaise = Math.round(priceRupees * 100);
            
            const productData = {
                name: document.getElementById('name').value.trim(),
                description: document.getElementById('description').value.trim() || null,
                hsn_code: document.getElementById('hsn_code').value.trim(),
                gst_rate: parseFloat(document.getElementById('gst_rate').value),
                price_paise: pricePaise,
                stock_quantity: parseInt(document.getElementById('stock_quantity').value),
                unit: document.getElementById('unit').value
            };

            // Add is_active for updates
            if (currentProductId) {
                productData.is_active = document.getElementById('is_active').checked;
            }

            try {
                const url = currentProductId 
                    ? `${API_URL}/products/${currentProductId}`
                    : `${API_URL}/products/`;
                
                const method = currentProductId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers,
                    body: JSON.stringify(productData)
                });

                if (response.ok) {
                    showModalSuccess(currentProductId ? 'Product updated successfully!' : 'Product created successfully!');
                    setTimeout(() => {
                        closeModal();
                        loadProducts();
                    }, 1500);
                } else {
                    const error = await response.json();
                    showModalError(error.detail || 'Operation failed');
                }
            } catch (err) {
                showModalError('Network error. Please check if backend is running.');
            }
        });

        async function deactivateProduct(id) {
            if (!confirm('Deactivate this product? It will not appear in new invoices.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/products/${id}`, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify({ is_active: false })
                });

                if (response.ok) {
                    loadProducts();
                } else {
                    showError('Failed to deactivate product');
                }
            } catch (err) {
                showError('Network error');
            }
        }

        async function activateProduct(id) {
            try {
                const response = await fetch(`${API_URL}/products/${id}`, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify({ is_active: true })
                });

                if (response.ok) {
                    loadProducts();
                } else {
                    showError('Failed to activate product');
                }
            } catch (err) {
                showError('Network error');
            }
        }

        function validateHSN(input) {
            // Only allow digits
            input.value = input.value.replace(/\D/g, '');
            
            // Validate length (4, 6, or 8 digits)
            const len = input.value.length;
            if (len > 0 && len !== 4 && len !== 6 && len !== 8) {
                input.setCustomValidity('HSN code must be exactly 4, 6, or 8 digits');
            } else {
                input.setCustomValidity('');
            }
        }

        function calculateTaxBreakup() {
            const price = parseFloat(document.getElementById('price').value) || 0;
            const gstRate = parseFloat(document.getElementById('gst_rate').value) || 0;
            
            if (price > 0 && gstRate > 0) {
                const basePrice = price / (1 + gstRate / 100);
                const taxAmount = price - basePrice;
                
                document.getElementById('base-price').textContent = basePrice.toFixed(2);
                document.getElementById('tax-amount').textContent = taxAmount.toFixed(2);
                document.getElementById('total-price').textContent = price.toFixed(2);
                document.getElementById('tax-breakup').classList.remove('hidden');
            } else {
                document.getElementById('tax-breakup').classList.add('hidden');
            }
        }

        function closeModal() {
            document.getElementById('product-modal').classList.add('hidden');
            document.getElementById('modal-error').classList.add('hidden');
            document.getElementById('modal-success').classList.add('hidden');
        }

        function showModalError(msg) {
            const errorDiv = document.getElementById('modal-error');
            errorDiv.textContent = msg;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function showModalSuccess(msg) {
            const successDiv = document.getElementById('modal-success');
            successDiv.textContent = msg;
            successDiv.classList.remove('hidden');
        }

        function showError(msg) {
            alert(msg);
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
